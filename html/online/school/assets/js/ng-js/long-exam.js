var app=angular.module("app",["ngFilter"]);app.controller("longExamController",["$scope","$filter",function(e,t){e.defaultPage=location.hash.substring(2)||1,e.pageSize=10,e.editData={},e.getDataList=function(){$.AJAX({type:"GET",url:config.basePath+"school/enroll/longtrain",data:{pageNo:e.defaultPage,pageSize:parseInt(e.pageSize),ctimeBegin:e.ctimeBegin,ctimeEnd:e.ctimeEnd,dateBegin:e.dateBegin,dateEnd:e.dateEnd,state:e.state},success:function(t){var a=getListData(t);e.total=a.total,e.datas=a.dataList,e.$apply(),new Page({parent:$("#copot-page"),nowPage:e.defaultPage,pageSize:e.pageSize,totalCount:a.total})}})},e.getDataList(),window.onhashchange=function(){win.showLoading(),e.defaultPage=location.hash.substring(2)||1,e.getDataList()},e.getDataForPage=function(){win.showLoading(),e.defaultPage=1,e.getDataList()},e.closeWin=function(){$("#edit-win").fadeOut("fast")},e.addItem=function(){$("#edit-win").fadeIn(),$("#edit-form").css("marginTop",parseInt(($(win).height()-$("#edit-form").height()-100)/2)+"px"),e.editData={},$("#coachInfo").empty(),$("#carInfo").empty()},e.editItem=function(a){$("#edit-win").fadeIn(),$("#edit-form").css("marginTop",parseInt(($(win).height()-$("#edit-form").height()-100)/2)+"px"),$("#coachInfo").empty(),$("#carInfo").empty(),e.editData=a,e.editData.classDate=new Date(a.classDate).format("yyyy-MM-dd"),e.editData.classTime_s=a.classTime.split("-")[0],e.editData.classTime_e=a.classTime.split("-")[1];var i="<i class='ion-checkmark-circled succes'></i> {1} | {2} | {3}".format(a.contactName,t("sexText")(a.coachSex),a.coachIdCard);$("#coachInfo").append(i);var c="<i class='ion-checkmark-circled succes'></i> {1} | {2} | {3}".format(a.carNo,a.carType,t("applyCarTypeTex")(a.drType));$("#carInfo").append(c)},e.searchCoach=function(){return void 0==e.editData.contactMobile||""==e.editData.contactMobile?(Layer.alert({width:300,height:150,type:"msg",title:"请填写教练电话号码！"}),!1):void $.AJAX({type:"GET",url:config.basePath+"school/enroll/longtrain/coach",data:{contactMobile:e.editData.contactMobile},success:function(a){$("#coachInfo").empty();var i=getListData(a);if(""!=i){var c="<i class='ion-checkmark-circled succes'></i> {1} | {2} | {3}".format(i.name,t("sexText")(i.sex),i.idNumber);$("#coachInfo").append(c),e.isCoachValid=1}else $("#coachInfo").append("<i class='ion-close-circled error'></i> 未找到相关教练信息"),e.isCoachValid=0}})},e.searchCar=function(){return void 0==e.editData.carNo||""==e.editData.carNo?(Layer.alert({width:300,height:150,type:"msg",title:"请填写车牌号！"}),!1):void $.AJAX({type:"GET",url:config.basePath+"school/enroll/longtrain/car",data:{carNo:e.editData.carNo},success:function(e){$("#carInfo").empty();var a=getListData(e);if(""!=a){var i="<i class='ion-checkmark-circled succes'></i> {1} | {2} | {3}".format(a.carNo,a.carType,t("applyCarTypeTex")(a.driveType));$("#carInfo").append(i)}else $("#carInfo").append("<i class='ion-close-circled error'></i> 未找到相关车辆信息")}})},e.getDataForCTime=function(a,i){switch($(a.target).addClass("active").siblings().removeClass("active"),i){case"":e.ctimeBegin=e.ctimeEnd="";break;case"0":e.ctimeBegin=t("date")((new Date).getTime()-6048e5,"yyyy-MM-dd"),e.ctimeEnd=t("date")((new Date).getTime(),"yyyy-MM-dd");break;case"1":e.ctimeBegin=t("date")((new Date).getTime()-1296e6,"yyyy-MM-dd"),e.ctimeEnd=t("date")((new Date).getTime(),"yyyy-MM-dd")}$("#cdate").val(""),e.getDataForPage()},e.getDataForSTime=function(a,i){switch($(a.target).addClass("active").siblings().removeClass("active"),i){case"":e.dateBegin=e.dateEnd="";break;case"0":e.dateBegin=t("date")((new Date).getTime()-6048e5,"yyyy-MM-dd"),e.dateEnd=t("date")((new Date).getTime(),"yyyy-MM-dd");break;case"1":e.dateBegin=t("date")((new Date).getTime()-1296e6,"yyyy-MM-dd"),e.dateEnd=t("date")((new Date).getTime(),"yyyy-MM-dd")}$("#sdate").val(""),e.getDataForPage()},e.getDataForState=function(t,a){$(t.target).addClass("active").siblings().removeClass("active"),e.state=a,e.getDataForPage()},e.submitItemInfo=function(){var t,a=!1;if($("#edit-form .form-control").each(function(e,i){return""==$(this).val()?(t=$(this).attr("placeholder"),a=!0,!1):void 0}),a)return void Layer.alert({width:300,height:150,type:"msg",title:t+"必须填写！"});var i=void 0==e.editData.ltId?"school/enroll/longtrain":"school/enroll/longtrain/modify";Layer.confirm({width:320,height:160,title:"确认提交当前的长考课程信息？",header:"提示"},function(){$.AJAX({type:"POST",url:config.basePath+i,data:{ltId:e.editData.ltId,contactMobile:e.editData.contactMobile,carNo:e.editData.carNo,classDate:e.editData.classDate,classTime:e.editData.classTime_s+"-"+e.editData.classTime_e,classPlace:e.editData.classPlace,carrys:e.editData.carrys},success:function(t){Layer.miss({width:250,height:90,title:"操作成功",closeMask:!0}),$("#edit-win").fadeOut("fast"),e.getDataList()}})})},e.comfirmLesson=function(t){var a=new Date(t.classDate).format("yyyy-MM-dd"),i=a+" "+t.classTime.substring(0,5);if(new Date(i).getTime()-(new Date).getTime()<0)return void Layer.alert({width:400,height:150,type:"msg",title:"已超过上课时间,本课程无效!"});if(0==t.total)return void Layer.alert({width:400,height:150,type:"msg",title:"请先安排上课学生,然后再确认开课!"});var c;$.AJAX({url:config.basePath+"school/enroll/longtrain/msgInfo?state=1",async:!1,type:"GET",success:function(e){c=e.result.pageData,c=c.format(a,t.carrys,t.classPlace,t.contactName+" "+t.contactMobile)}});var n="您是否确认要提交该长训课程并短信通知学员上课？";new Date(i).getTime()-(new Date).getTime()<72e4&&(n="距离上课时间不足12小时，您确认继续提交该长训课程并短信通知学员上课？");var s="<h4 align='center'><strong>"+n+"</strong></h4>";s+="<div class='msg-padding'>短信内容预览：<br><hr class='sub-line'/>"+c+"</div>",Layer.confirm({width:650,height:350,title:s,header:"确认开课"},function(){$.AJAX({url:config.basePath+"school/enroll/longtrain/class",type:"POST",data:{ltId:t.ltId,state:1},success:function(t){Layer.miss({width:250,height:90,title:"操作成功",closeMask:!0}),e.getDataForPage()}})})},e.cancelLesson=function(t){var a,i=new Date(t.classDate).format("yyyy-MM-dd");$.AJAX({url:config.basePath+"school/enroll/longtrain/msgInfo?state=3",async:!1,type:"GET",success:function(e){a=e.result.pageData,a=a.format(i,"长考")}});var c="您是否确认要取消该长训课程并短信通知学员？",n="<h4 align='center'><strong>"+c+"</strong></h4>";n+="<div class='msg-padding'>短信内容预览：<br><hr class='sub-line'/>"+a+"</div>",Layer.confirm({width:600,height:350,title:n,header:"取消课程"},function(){$.AJAX({url:config.basePath+"school/enroll/longtrain/class",type:"POST",data:{ltId:t.ltId,state:3},success:function(t){Layer.miss({width:250,height:90,title:"操作成功",closeMask:!0}),e.getDataForPage()}})})},$(".classsDate").datetimepicker({startDate:new Date,autoclose:1,startView:2,minView:2,maxView:2,forceParse:0}),$(".timepicker").datetimepicker({autoclose:1,startView:1,minView:0,maxView:1,forceParse:0}),$(".timepicker").datetimepicker().on("show",function(t){$(".timepicker").datetimepicker("setStartDate",e.editData.classDate)}),$("#cdate").daterangepicker({format:"YYYY-MM-DD"},function(a,i,c){e.ctimeBegin=t("date")(a.toISOString(),"yyyy-MM-dd"),e.ctimeEnd=t("date")(i.toISOString(),"yyyy-MM-dd"),e.getDataForPage()}),$("#sdate").daterangepicker({format:"YYYY-MM-DD"},function(a,i,c){e.dateBegin=t("date")(a.toISOString(),"yyyy-MM-dd"),e.dateEnd=t("date")(i.toISOString(),"yyyy-MM-dd"),e.getDataForPage()})}]);