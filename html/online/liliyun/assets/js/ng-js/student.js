var app=angular.module("app",["ngFilter","ngSelects"]);app.controller("Student",["$scope","$rootScope","$filter","Selects",function(t,e,a,i){function s(e){var a={url:config.basePath+"student/lili-batch",data:{pageNo:e,pageSize:parseInt(t.pageSize),applyCarType:t.carType,applyexam:t.applystateTotal.split(",")[0],applystate:t.applystateTotal.split(",")[1],schoolNo:t.schoolNo,schoolType:t.schoolType,type:0}};return a.data[t.searchType]=t.search,a}function n(e){var a={phoneNum:t.editData.phoneNum,sex:parseInt(t.editData.sex),applyCarType:parseInt(t.editData.applyCarType),idNumber:t.editData.idNumber,name:t.editData.name,studentId:t.editData.studentId,schoolId:t.editData.schoolId};return{url:config.basePath+e,data:a}}t.defaultPage=location.hash.substring(2)||1,t.pageSize=10,t.carType="",t.search="",t.searchType="name",t.schoolNo="",t.cityId="",t.cityError=!1,t.applystateTotal=",",t.schoolType="",t.statusId="",t.textRemark="",t.applyttid="",t.lockState="1",t.data={pages:10,total:100,pageSize:10,pageNo:1,dataList:[{studentId:0,name:"小张",sex:0,applyexam:4,applystate:1,phoneNum:"13476002586",applyCarType:1,coach:"张教练",idNumber:"422802198910116575",drivingSchool:"深港",accountStatus:0},{studentId:2,name:"小张",sex:1,applyexam:7,applystate:100,phoneNum:"13476002586",applyCarType:2,coach:"张教练",idNumber:"422802198910116575",drivingSchool:"深港",accountStatus:0}]},t.datas=t.data.dataList,i.selects({datas:t.datas,whichId:"studentId"}),t.getDataList=function(){var e=s(t.defaultPage);$.AJAX({type:"get",url:e.url,data:e.data,success:function(e){var a=getListData(e);t.total=a.total,t.datas=a.dataList,i.selects({datas:t.datas,whichId:"studentId"}),t.$apply(),new Page({parent:$("#copot-page"),nowPage:t.defaultPage,pageSize:t.pageSize,totalCount:a.total})}})},t.getDataList(),window.onhashchange=function(){win.showLoading(),t.defaultPage=location.hash.substring(2)||1,t.getDataList()},queryCity({callback:function(e){t.citys=e,t.$apply()}}),t.getSchools=function(){t.cityId?(t.checkHaveCity(),$("#select-school li").last().addClass("active").siblings().removeClass("active"),querySchool({cityId:t.cityId,callback:function(e){t.schools=e,t.$apply()}})):($("#select-school li").first().addClass("active").siblings().removeClass("active"),t.schoolNo="",t.schools="")},t.checkHaveCity=function(){t.cityError=!t.cityId},t.getDataForDistSchool=function(e,a){$(e.target).addClass("active").siblings().removeClass("active"),win.showLoading(),t.schoolType=a,t.defaultPage=1,t.schoolNo="",t.cityId="",t.getDataList()},t.getDataForSchool=function(){win.showLoading(),t.defaultPage=1,t.schoolType=2,t.getDataList()},t.getDataForCarType=function(e,a){$(e.target).addClass("active").siblings().removeClass("active"),win.showLoading(),t.carType=a,t.defaultPage=1,t.checkAllTag.carType=$(e.target).text(),t.objElement.carType=$(e.target),t.getDataList()},t.studentStatesList=studentStatesListForLiLi,t.comSearTabCheck=function(e,a){var i="DIV"==e.target.nodeName?$(e.target):$(e.target).parent("div");$("div.tab-par").removeClass("active"),$("div.tab-chr").hide(),i.addClass("active").next("div").show(),$("div.tab-par").find("span").attr("class","ion-arrow-up-b"),i.find("span").attr("class","ion-arrow-down-b"),"all"==a&&(t.defaultPage=1,t.getDataForStudentState(e,""))},t.getDataForStudentState=function(e,a){$(e.target).addClass("active").siblings().removeClass("active"),win.showLoading(),t.applystateTotal=a,t.defaultPage=1,t.checkAllTag.applystateTotal=$(e.target).text(),t.objElement.applystateTotal=$(e.target),t.getDataList()},t.getDataForPage=function(){win.showLoading(),t.defaultPage=1,t.getDataList()},t.getDataForSearch=function(){win.showLoading(),t.defaultPage=1,t.checkAllTag.search=t.search,t.getDataList()},t.studentDataExport=function(){dataExportForIframe({getSearchs:s(t.defaultPage).data,total:t.total,url:"student/export-excel"})},t.checkAllTag={},t.objElement={},t.removeTag=function(e){win.showLoading(),t.checkAllTag=deleteJson(t.checkAllTag,e),t.objElement[e]&&("LI"==t.objElement[e][0].nodeName?t.objElement[e].parent().children().eq(0).addClass("active").siblings().removeClass("active"):"children"==$(t.objElement[e][0]).attr("data-chr")&&(t.objElement[e].parent().removeClass("active"),t.objElement[e].parent().hide().children().removeClass("active"),t.objElement[e].parents("ul").find("div.tab-par").removeClass("active"),t.objElement[e].parents("ul").children().eq(0).children().addClass("active"))),t[e]="",t.getDataList()},t.removeAllTag=function(){jQuery.isEmptyObject(t.objElement)||(win.showLoading(),t.carType="",t.schoolNo="",t.applystateTotal="",clearAllActive(t.objElement),t.checkAllTag={},t.objElement={},$("div.tab-line ul").find(".tab-par").removeClass("active"),$("div.tab-line ul").find("li").eq(0).children("div").addClass("active"),$("div.tab-chr").hide().children("div").removeClass("active"),t.getDataList())},t.sutdentEditLoad=function(){$(".closeAlert").click(function(){$(this).parents("div.student-alert").fadeOut("fast")})},t.editData={},t.studentEdit=function(e){$(".student-alert").fadeIn("fast"),$("#student-alert").css("marginTop",parseInt(($(win).height()-$("#student-alert").height()-100)/2)+"px"),t.editData=e},t.getSchoolDatas=function(e){e?(t.cityDataError=!1,querySchool({cityId:e,callback:function(e){t.schools=e,t.$apply()}})):(t.schools="",t.cityDataError=!0)},t.checkIsCityId=function(e){return t.cityDataError=!e},t.submitEditMsg=function(e){var a=n("student/update");return t.editData.phoneNum.length<11||!regCombination("*").test(t.editData.phoneNum)?(Layer.alert({type:"msg",height:150,title:"请填手机正确的号码"}),!1):void $.AJAX({url:a.url,data:a.data,success:function(a){$(e.target).parents("div.student-alert").fadeOut("fast"),Layer.miss({width:250,height:90,title:"操作成功",closeMask:!0}),t.getDataList()}})},t.closeAlert=function(){t.editData={},t.getDataList()},t.studentStates=[],t.haveStudentState=!1,t.incompleteData="",t.StudentStateLoad=function(){$(".closeAlert").click(function(){$(this).parents("div.student-state").fadeOut("fast")})},t.changeStudentState=function(){return t.studentStates=[],$("#studentState").val(""),e.idList.length?($(".student-state").fadeIn("fast"),$("#student-state").css("marginTop",parseInt(($(win).height()-$("#student-state").height()-100)/2)+"px"),void getDataForStudentConfig({datas:getDataForKey({datas:t.datas,idList:t.idList,id:"studentId"}),check:"applyexam,applystate",checkData:studentLiLiJurisConfig,callback:function(e){t.studentStates=e,t.haveStudentState=!!e.length}})):(Layer.alert({width:300,height:150,type:"msg",title:"请选择需要置状态的学员！"}),!1)},t.changeErrorStudentLoad=function(){$(".closeAlert").click(function(){$(this).parents("div.change-error-students").fadeOut("fast")}),$("#studentState").change(function(){"5,101"==$(this).val()?$("#queshizl").show():$("#queshizl").hide()})},t.submitStudentState=function(a,i){var s=$("#studentState").val();return regCombination("*").test(s)?"5,101"!=s||regCombination("*").test(i)?void $.AJAX({url:config.basePath+"student/reset-state",data:{applyexam:s.split(",")[0],applystate:s.split(",")[1],studentIds:e.idList.toString(),remarks:i},success:function(e){"fail"==e.status?($(".change-error-students").fadeIn("fast"),$("#change-error-students").css("marginTop","150px"),t.errDataList=studentStateRes(getListData(e)),t.$apply()):($(a.target).parents("div.student-state").fadeOut("fast"),Layer.miss({width:250,height:90,title:"操作成功",closeMask:!0}),t.getDataList())}}):(Layer.alert({width:300,height:150,type:"msg",title:"请补充资料不全的理由！"}),!1):(Layer.alert({width:300,height:150,type:"msg",title:"请选择学员需要置的状态！"}),!1)},t.closeChanErrorStud=function(t){$(t.target).parents("div.change-error-students").fadeOut("fast")},t.infImperfect=function(){$(".closeAlert").click(function(){$(this).parents("div.data-imperfect").fadeOut("fast")})},t.getStatusDatas=function(e){t.ptype=e;for(var a=t.statusdatas[e-1].pmid.split(","),i=t.allperdatas,s=new Array,n=0;n<a.length;n++)for(var d=a[n],r=0;r<i.length;r++)d==i[r].pmid&&s.push(i[r]);t.perdatas=s},t.dataHasMail=function(){if(t.ptype="",!e.idList.length)return Layer.alert({width:300,height:150,type:"msg",title:"请选择'资料待邮寄'的学员！"}),!1;var a=getDataForKey({datas:t.datas,id:"studentId",idList:e.idList});t.applyttid=a[0].applyttid,t.studentId=a[0].studentId;for(var i=[],s=0;s<a.length;s++){i.push(a[s].applyttid);i.indexOf(i[s])}return 4!=a[0].applyexam&&3!=a[0].applyexam||0!=a[0].applystate?(Layer.alert({width:410,height:175,type:"msg",title:"您只能把'未邮寄资料'的学员标记为资料<br>已邮寄，请重新选择学员！"}),!1):null==a[0].idNumber||null==a[0].applyCarType?(Layer.alert({width:410,height:175,type:"msg",title:"请您先编辑添加学员身份证及<br>报考类别信息！"}),!1):void Layer.confirm({width:300,height:160,title:"您确认收到了所选学员的<br>报名表资料吗？",header:"资料已邮寄"},function(){$.AJAX({url:config.basePath+"student/reset-state",data:{applyexam:4,applystate:1,applyttid:t.applyttid,studentIds:e.idList.toString()},success:function(e){Layer.miss({width:250,height:90,title:"操作成功",closeMask:!0}),t.getDataList()}})})},t.dataImperfect=function(){if(t.ptype="",!e.idList.length)return Layer.alert({width:300,height:150,type:"msg",title:"请选择'资料已邮寄'的学员！"}),!1;var a=getDataForKey({datas:t.datas,id:"studentId",idList:e.idList});t.applyttid=a[0].applyttid,t.studentId=a[0].studentId;for(var i=[],s=0;s<a.length;s++){i.push(a[s].applyttid);var n=i.indexOf(i[s])}return 0!=n?(Layer.alert({width:330,height:175,type:"msg",title:"您只能选择同一城市的学员，<br>请重新选择学员！"}),!1):4!=a[0].applyexam||1!=a[0].applystate?(Layer.alert({width:410,height:175,type:"msg",title:"您只能把'资料已邮寄'的学员标记为资料<br>不全，请重新选择学员！"}),!1):($.AJAX({url:config.basePath+"student/pack-detail",type:"get",data:{applyttid:t.applyttid},success:function(e){var a=e.data.people,i=e.data.items;t.statusdatas=a,t.perdatas=i,t.allperdatas=i,t.$apply()}}),$(".data-imperfect").fadeIn("fast"),$("#imperfect-alert").css("marginTop",parseInt(($(win).height()-$("#imperfect-alert").height()-100)/2)+"px"),void(t.submitImperfectMsg=function(e){var a=t.idList;a.shift();return console.log(t.ptype),regCombination("*").test(t.ptype)?regCombination("*").test(t.textRemark)?void $.AJAX({url:config.basePath+"student/reset-state",data:{applyexam:4,applystate:101,applyttid:t.applyttid,pmid:t.idList.toString(),ptype:t.ptype,studentIds:t.studentId,note:t.textRemark},success:function(a){$(e.target).parents("div.data-imperfect").fadeOut("fast"),Layer.miss({width:250,height:90,title:"操作成功",closeMask:!0}),t.getDataList()}}):(Layer.alert({width:300,height:150,type:"msg",title:"请输入缺失的资料说明！"}),!1):(Layer.alert({width:300,height:150,type:"msg",title:"请选择身份信息！"}),!1)}))},t.infComplete=function(){$(".closeAlert").click(function(){$(this).parents("div.data-complete").fadeOut("fast")})},t.getStatusinf=function(e){e?(t.ptypeed=e,t.statusDataError=!1):(t.isstatus="",t.statusDataError=!0,t.ptypeed="")},t.dataComplete=function(){if(t.ptypeed="",!e.idList.length)return Layer.alert({width:300,height:150,type:"msg",title:"请选择'资料已邮寄'的学员！"}),!1;var a=getDataForKey({datas:t.datas,id:"studentId",idList:e.idList});t.applyttid=a[0].applyttid;for(var i=[],s=0;s<a.length;s++){i.push(a[s].applyttid);var n=i.indexOf(i[s])}return 0!=n?(Layer.alert({width:330,height:175,type:"msg",title:"您只能选择同一城市的学员，<br>请重新选择学员！"}),!1):4!=a[0].applyexam||1!=a[0].applystate?(Layer.alert({width:410,height:175,type:"msg",title:"您只能把'资料已邮寄'的学员标记为资料<br>不全，请重新选择学员！"}),!1):($.AJAX({url:config.basePath+"student/pack-detail",type:"get",data:{applyttid:t.applyttid},success:function(e){var a=e.data.people;t.statusdatas=a,t.$apply()}}),$(".data-complete").fadeIn("fast"),$("#complete-alert").css("marginTop",parseInt(($(win).height()-$("#complete-alert").height()-100)/2)+"px"),void(t.submitCompleteMsg=function(a){return regCombination("*").test(t.ptypeed)?void $.AJAX({url:config.basePath+"student/reset-state",data:{applyexam:4,applystate:100,applyttid:t.applyttid,ptype:t.ptypeed,studentIds:e.idList.toString()},success:function(e){$(a.target).parents("div.data-complete").fadeOut("fast"),Layer.miss({width:250,height:90,title:"操作成功",closeMask:!0}),t.getDataList()}}):(Layer.alert({width:300,height:150,type:"msg",title:"请选择身份信息！"}),!1)}))},t.dataSent=function(){if(!e.idList.length)return Layer.alert({width:300,height:150,type:"msg",title:"请选择'未交表'的学员！",header:"表已寄出"}),!1;var a=getDataForKey({datas:t.datas,id:"studentId",idList:e.idList});t.applyttid=a[0].applyttid;for(var i=[],s=0;s<a.length;s++){i.push(a[s].applyttid);var n=i.indexOf(i[s])}return 0!=n?(Layer.alert({width:330,height:175,type:"msg",title:"您只能选择同一城市的学员，<br>请重新选择学员！"}),!1):5!=a[0].applyexam||0!=a[0].applystate?(Layer.alert({width:355,height:175,type:"msg",title:"您只能把'未交表'的学员标记为表已<br>寄出，请重新选择学员！",header:"表已寄出"}),!1):void Layer.confirm({width:300,height:160,title:"您确认寄出所选学员的报<br>名表资料吗？",header:"表已寄出"},function(){$.AJAX({url:config.basePath+"student/reset-state",data:{applyexam:5,applystate:1,applyttid:t.applyttid,studentIds:e.idList.toString()},success:function(e){Layer.miss({width:250,height:90,title:"操作成功",closeMask:!0}),t.getDataList()}})})},t.sutdentLockEditLoad=function(){$(".closeAlert").click(function(){$(this).parents("div.student-lock-alert").fadeOut("fast")}),$("#reservation").daterangepicker({format:"YYYY-MM-DD",singleDatePicker:!0,autoclose:!0,timePicker:!0,timePicker24Hour:!0,timePickerSeconds:!0,autoApply:!0})},t.editData.state=1,t.editData.lockManRequire="",t.lockTimeShow=function(e){$(".student-lock-edit-time").slideDown("fast"),t.editData.state=$(e.target).val()},t.lockTimeHidden=function(e){$(".student-lock-edit-time").slideUp("fast"),t.editData.state=$(e.target).val()},t.dataLock=function(){return e.idList.length?($(".student-lock-alert").fadeIn("fast"),$("#edit-content").css("marginTop",parseInt(($(win).height()-$("#edit-content").height()-100)/2)+"px"),void(t.submitStudentLock=function(){if(!t.editData.note)return Layer.alert({width:300,height:150,type:"error",title:"请填写封号/解封理由"}),!1;var a="",i="";switch(parseInt(t.editData.state)){case 0:a="确定将此学员帐号解封？",i="被封号";break;case 1:a="确定将此学员帐号临时封号？",i="正常";break;case 2:a="确定将此学员帐号永久封号？",i="正常"}for(var s=getDataForKey({datas:t.datas,id:"studentId",idList:e.idList}),n=!0,d=0;d<s.length;d++)if(t.editData.state==s[d].state){n=!1;break}return n?void Layer.confirm({width:300,height:160,title:a,header:"学员封号"},function(){$.AJAX({url:config.basePath+"student/lock-batch",data:{ids:e.idList.toString(),state:t.editData.state,reviveTime:t.editData.reviveTime,note:t.editData.note},success:function(e){Layer.miss({width:250,height:90,title:"操作成功",closeMask:!0}),t.getDataList(),$("div.student-lock-alert").fadeOut("fast")}})}):(Layer.alert({width:430,height:175,type:"msg",title:"您只能选择状态"+i+"的学员，<br>请重新选择！"}),!1)})):(Layer.alert({width:300,height:150,type:"msg",title:"请选择要封号的学员！",header:"学员封号"}),!1)}}]);