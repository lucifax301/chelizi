var app=angular.module("app",["ngFilter","ngSelects"]);app.controller("CouponDetails",["$scope","$rootScope","$filter","Selects",function(t,e,a,o){function i(e){var a={url:config.basePath+"coupon/stucoupon-batch",data:{pageNo:e,pageSize:parseInt(t.pageSize),type:t.type,coupontmpid:t.couponId}};return a}t.defaultPage=location.hash.substring(2)||1,t.pageSize=10,t.couponId=getQueryString("couponId"),t.type="",t.getCouponDetailsData=function(){$.AJAX({type:"get",url:config.basePath+"coupon/coupon-view",data:{coupontmpid:t.couponId},success:function(e){t.data=JSON.parse(e.result.coupon),t.data.genRuleTmp=t.data.genrule.split("|")[1].replace(/,/," and "),t.data.useRuleTmp=t.data.userule.split("|")[1].replace(/,/," and "),console.log(t.data),t.$apply()}})},t.getCouponDetailsData(),o.selects({datas:t.datas,whichId:"couponid"}),t.getDataList=function(){var e=i(t.defaultPage);$.AJAX({type:"get",url:e.url,data:e.data,success:function(e){var a=getListData(e);t.total=a.total,t.datas=a.dataList,o.selects({datas:t.datas,whichId:"couponid"}),t.$apply(),topLongText(),new Page({parent:$("#copot-page"),nowPage:t.defaultPage,pageSize:t.pageSize,totalCount:a.total})}})},t.getDataList(),window.onhashchange=function(){win.showLoading(),t.defaultPage=location.hash.substring(2)||1,t.getDataList()},t.useType=function(e,a){$(e.target).addClass("active").siblings().removeClass("active"),win.showLoading(),t.defaultPage=1,t.type=a,t.getDataList()},t.getDataForPage=function(){win.showLoading(),t.defaultPage=1,t.getDataList()},t.addCouponLoad=function(){$(".closeAlert").click(function(){$(this).parents("div.add-coach").fadeOut("fast")})},t.addCoupon=function(e){return 1!=parseInt(e.verify)?(Layer.alert({width:300,height:160,type:"msg",title:"该优惠券未经审核，不能追加!",header:"追加发行"}),!1):($(".add-coach").fadeIn("fast"),$("#add-coach").css("marginTop",parseInt(($(win).height()-$("#add-new-car").height()-200)/2)+"px"),t.addCoachNub="",t.coupontmpId=e.coupontmpid,t.name=e.name,t.releasedAmount=e.releasedAmount,void(t.leftAmount=e.leftAmount))},t.submitCoachMsg=function(e){return regCombination("*").test(t.addCoachNub)?/^[0-9]*[1-9][0-9]*$/.test(t.addCoachNub)?void $.AJAX({url:config.basePath+"coupon/add-stock",data:{couponTmpId:t.coupontmpId,addTotal:t.addCoachNub},success:function(a){$(e.target).parents("div.add-coach").fadeOut("fast"),Layer.miss({width:250,height:90,title:"操作成功",closeMask:!0}),t.getCouponDetailsData()}}):(Layer.alert({width:450,height:160,type:"msg",title:"追加发行的数量不合法!",header:"追加发行"}),!1):(Layer.alert({width:450,height:160,type:"msg",title:"请输入追加发行的数量!",header:"追加发行"}),!1)},t.inactiveAction=function(e){return 0==e.isexist?(Layer.alert({width:450,height:175,type:"msg",title:"该优惠券尚未生效，无法停止发放",header:"停止发放"}),!1):1!=parseInt(e.verify)?(Layer.alert({width:450,height:160,type:"msg",title:"该优惠券未经审核，无法停止发放!",header:"停止发放"}),!1):void Layer.confirm({width:450,height:160,title:"确认停用选中券模板吗？",header:"停止发放"},function(){$.AJAX({url:config.basePath+"coupon/cancle-coupon",data:{ids:t.couponId},success:function(e){Layer.miss({width:250,height:90,title:"操作成功",closeMask:!0}),t.getCouponDetailsData()}})})},t.activeAction=function(e){return 1==e.isexist?(Layer.alert({width:450,height:175,type:"msg",title:"该优惠券已激活启用，不能再次激活",header:"激活启用"}),!1):1!=parseInt(e.verify)?(Layer.alert({width:450,height:160,type:"msg",title:"该优惠券未经审核，不能激活启用!",header:"激活启用"}),!1):void Layer.confirm({width:450,height:160,title:"确认激活选中券模板吗？",header:"激活启用"},function(){$.AJAX({url:config.basePath+"coupon/active-coupon",data:{ids:t.couponId},success:function(e){Layer.miss({width:250,height:90,title:"操作成功",closeMask:!0}),t.getCouponDetailsData()}})})},t.addNewCouponLoad=function(){$(".closeAlert").click(function(){$(this).parents("div.add-new-coupon").fadeOut("fast"),t.isBindCarShow=!1})},t.isBindCarShow=!1,t.addStuCopon=function(){$(".add-new-coupon").fadeIn("fast"),$("#add-new-coupon").css("marginTop",parseInt(($(win).height()-$("#add-new-coupon").height()-200)/2)+"px"),t.isBindCarShow=!1},t.phoneNum="",t.searchCouponDetails=function(e){return e&&regCombination("*").test(e)?(t.isbindCouponShow=!0,win.showLoading(),void $.AJAX({url:config.basePath+"student/phone",type:"get",data:{phoneNum:t.phoneNum},success:function(e){console.log(e),t.bindCouponDetails=JSON.parse(e.result.pageData),t.$apply()}})):(Layer.alert({type:"msg",title:"请输入手机号!"}),!1)},t.submitBindCoupon=function(e){return 1!=t.data.verify||1!=t.data.isexist?(Layer.alert({width:300,height:170,type:"msg",title:"当前券未审核通过或未激活，<br>不能对外发放！",header:"指定学员发券"}),!1):void $.AJAX({url:config.basePath+"coupon/student-coupon",type:"get",data:{couponTempId:t.couponId,studentId:t.bindCouponDetails.studentId},success:function(a){$(e.target).parents("div.edit-alert").fadeOut("fast"),Layer.miss({width:250,height:90,title:"操作成功",closeMask:!0}),window.location.href="coupon-details.html?couponId="+t.couponId}})},t.writtenOff=function(){for(var a=getDataForKey({datas:t.datas,id:"couponid",idList:e.idList}),o=!0,i=[],n=0;n<a.length;n++)if(i.push(a[n].couponid),1!=a[n].type){o=!1;break}return e.idList.length?0==o?(Layer.alert({width:340,height:170,type:"msg",title:"已注销,已过期或已使用的优惠券<br>不能注销！",header:"注销"}),!1):void Layer.confirm({width:315,height:170,title:"注销后不可恢复，您确认注销<br>所选优惠券吗？",header:"注销"},function(){$.AJAX({url:config.basePath+"coupon/cancle-stucoupon",data:{couponid:i.toString()},success:function(e){Layer.miss({width:250,height:90,title:"操作成功",closeMask:!0}),t.getDataList()}})}):(Layer.alert({width:300,height:150,type:"msg",title:"请选择'未使用'的优惠券！",header:"注销"}),!1)}}]);