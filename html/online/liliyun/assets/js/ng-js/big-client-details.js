var app=angular.module("app",["ngFilter","ngSelects"]);app.controller("clientDetails",["$scope","$rootScope","$filter","Selects",function(t,e,a,i){function n(e){var a={url:config.basePath+"vip/custom-batch",data:{coid:t.coid,pageNo:e,pageSize:parseInt(t.pageSize)}};return 4==t.coid&&(a.data.vipBig="",a.data.rcid=160701003),a.data[t.searchType]=t.search,a}t.defaultPage=location.hash.substring(2)||1,t.pageSize=10,t.coid=getQueryString("coid"),t.cityId=getQueryString("cityId"),t.searchType="mobile",t.search="",t.allPlans="",$.AJAX({type:"GET",url:config.basePath+"vip/company-view",data:{coid:t.coid},success:function(e){t.item=getListData(e),t.$apply()}}),t.getDataList=function(){var e=n(t.defaultPage);$.AJAX({type:"GET",url:e.url,data:e.data,success:function(e){var a=getListData(e);t.datas=a.dataList,i.selects({datas:t.datas,whichId:"studentId",num:""}),t.$apply(),new Page({parent:$("#copot-page"),nowPage:t.defaultPage,pageSize:t.pageSize,totalCount:a.total})}})},t.getDataList(),t.rcDatas=[],t.rcname="",$.AJAX({type:"get",url:config.basePath+"vip/plan-batch",data:{pageNo:1,pageSize:100,name:t.name},success:function(e){var a=getListData(e),i=a.dataList;t.rcDatas=[];for(var n=0;n<i.length;n++)1==i[n].vtype&&t.rcDatas.push(i[n]);t.$apply()}}),t.getDataList(),window.onhashchange=function(){win.showLoading(),t.defaultPage=location.hash.substring(2)||1,t.getDataList()},t.getDataForPage=function(){win.showLoading(),t.defaultPage=1,t.getDataList()},t.getDataForSearch=function(){win.showLoading(),t.defaultPage=1,t.getDataList()},t.setVpass=function(){if(!e.idList.length)return Layer.alert({width:300,height:150,type:"msg",title:"您尚未选择学员！",header:"审核大客户"}),!1;for(var a=getDataForKey({datas:t.datas,id:"studentId",idList:e.idList}),i=0;i<a.length;i++){if(1==a[i].vstate)return Layer.alert({width:300,height:150,type:"msg",title:"您不能审核已通过的学员！",header:"审核大客户"}),!1;if(8==a[i].vstate)return Layer.alert({width:300,height:150,type:"msg",title:"该学员已审核，但方案未生效！",header:"审核大客户"}),!1}Layer.confirm({width:300,height:160,title:"确认审核通过吗？",header:"审核通过"},function(){$.AJAX({url:config.basePath+"vip/pass-custom",data:{studentIds:e.idList.toString()},code:!0,success:function(){e.idList=[],Layer.miss({width:250,height:90,title:"审核成功",closeMask:!0}),t.getDataList()}})})},t.setVfail=function(){if(!e.idList.length)return Layer.alert({width:300,height:150,type:"msg",title:"您尚未选择学员！",header:"审核大客户"}),!1;for(var a=getDataForKey({datas:t.datas,id:"studentId",idList:e.idList}),i=0;i<a.length;i++)if(0!=a[i].vstate)return Layer.alert({width:300,height:150,type:"msg",title:"您只能选择待审的学员！",header:"审核大客户"}),!1;Layer.confirm({width:300,height:160,title:"确认审核不通过吗？",header:"审核不通过"},function(){$.AJAX({url:config.basePath+"vip/refuse-custom",data:{studentIds:e.idList.toString(),reason:"拒绝"},success:function(){e.idList=[],Layer.miss({width:250,height:90,title:"审核成功",closeMask:!0}),t.getDataList()}})})},t.addIn=function(){$(".client-alert-in").fadeIn("fast"),$("#client-alert-in").css("marginTop",parseInt(($(win).height()-$("#client-alert-in").height()-100)/2)+"px"),$(".closeAlert-in").click(function(){$(this).parents("div.client-alert-in").fadeOut("fast")})},t.addOut=function(){$(".client-alert-out").fadeIn("fast"),$("#client-alert-out").css("marginTop",parseInt(($(win).height()-$("#client-alert-out").height()-100)/2)+"px"),$(".closeAlert-out").click(function(){$(this).parents("div.client-alert-out").fadeOut("fast")})},t.searchStuRzt={},t.searchStudent=function(){return void 0==t.searchPhoneNum||""==t.searchPhoneNum?(Layer.alert({width:300,height:150,type:"msg",title:"请填写学员电话号码！"}),!1):void $.AJAX({type:"GET",url:config.basePath+"student/phone",data:{phoneNum:t.searchPhoneNum},success:function(e){t.searchStuRzt=JSON.parse(e.result.pageData),$("#studentInfo").empty();var i=!1;if(""!=t.searchStuRzt){i=!0;var n="<i class='ion-checkmark-circled succes'></i> {1} | {2} | {3}".format(t.searchStuRzt.name?t.searchStuRzt.name:"喱喱学员",t.searchStuRzt.sex?a("sexText")(t.searchStuRzt.sex):"性别未知",t.searchStuRzt.idNumber?t.searchStuRzt.idNumber:"身份证号未知");$("#studentInfo").append(n),$("#addClientStuIn").off("click").on("click",function(){return i?$("#selRcid").val()?void $.AJAX({url:config.basePath+"vip/add-custom",data:{studentId:t.searchStuRzt.studentId,name:t.searchStuRzt.name,vipId:t.coid,vipPackageId:t.rcid,mobile:t.searchStuRzt.phoneNum,cname:t.searchStuRzt.cname,coid:t.coid,rcid:t.rcid},success:function(e){Layer.miss({width:250,height:90,title:"添加成功",closeMask:!0}),$(".edit-alert").fadeOut(),t.searchPhoneNum="",$("#studentInfo").empty(),t.rcid="",t.getDataList()}}):(Layer.alert({width:300,height:150,type:"msg",title:"尚未选择方案！"}),!1):(Layer.alert({width:300,height:150,type:"msg",title:"尚未指定学员！"}),!1)})}else $("#studentInfo").append("<i class='ion-close-circled error'></i> 未找到相关学员信息")}})},t.createFileForm=function(){cerateFileFormData({url:config.basePath+"vip/upload",data:{coid:t.coid},callback:function(e){t.excelInfo=e.result,console.log(t.excelInfo),Layer.miss({width:250,height:90,title:"导入成功",closeMask:!0}),setTimeout(function(){window.location.href="import-bigclient-rzt.html?id="+t.excelInfo.id+"&sum="+t.excelInfo.sum+"&validSum="+t.excelInfo.validSum+"&cityId="+t.cityId+"&coid="+t.coid},500)}})},t.downLoadData=function(){Layer.confirm({width:300,height:160,title:"本次导出最多支持1000条数据",header:"数据导出"},function(){dataExportForIframe({getSearchs:n(t.defaultPage).data,total:t.total,url:"/vip/export-excel"})})},t.downLoadTemp=function(){window.location.href=config.basePath+"/vip/download"},t.bornYears=[];for(var r=parseInt((new Date).getFullYear())-17;r>parseInt((new Date).getFullYear())-70;r--)t.bornYears.push(r);t.bornMonth=[];for(var r=1;12>=r;r++)t.bornMonth.push(r);t.provinceArr=provinceArr,t.cityArr=cityArr,t.getCityArr=t.cityArr[0],t.getCityIndexArr=["0","0"],t.provinceChange=function(e){t.getCityArr=t.cityArr[e],t.getCityIndexArr[1]="0",t.getCityIndexArr[0]=e},t.cityChange=function(e){t.getCityIndexArr[1]=e},t.addNewData={},t.addNewStu=function(){return t.addNewData.name?t.addNewData.sex?!t.addNewData.phoneNum||t.addNewData.phoneNum.length<11?(Layer.alert({width:400,height:175,type:"msg",title:"请检查电话号码",header:"新增学员"}),!1):!t.addNewData.idNum||18!=t.addNewData.idNum.length&&15!=t.addNewData.idNum.length?(Layer.alert({width:400,height:175,type:"msg",title:"请检查身份证号",header:"新增学员"}),!1):t.rcid?t.addNewData.cid?void $.AJAX({url:config.basePath+"vip/new-student",data:{coid:t.coid,name:t.addNewData.name,sex:t.addNewData.sex,vstate:0,vipId:t.coid,vipPackageId:t.rcid,rcid:t.rcid,idNumber:t.addNewData.idNum,phoneNum:t.addNewData.phoneNum,cityId:t.cityId,cid:t.addNewData.cid,hometown:$("#hometownP option:selected").text()+$("#hometownC option:selected").text()},code:!0,success:function(){$("div.client-alert-out").fadeOut("fast"),Layer.miss({width:250,height:90,title:"添加成功",closeMask:!0}),t.getDataList()}}):(Layer.alert({width:400,height:175,type:"msg",title:"请输入工号",header:"新增学员"}),!1):(Layer.alert({width:400,height:175,type:"msg",title:"请选择优惠方案",header:"新增学员"}),!1):(Layer.alert({width:400,height:175,type:"msg",title:"请选择性别",header:"新增学员"}),!1):(Layer.alert({width:400,height:175,type:"msg",title:"请输入姓名",header:"新增学员"}),!1)}}]);