var app=angular.module("app",["ngFilter"]);app.controller("CouponAdd",["$scope","$compile","$filter",function(e,t,a,r){e.defaultPage=location.hash.substring(2)||1,e.editData={},e.editData.indepentuse=1,e.couponType=[{type:"0",info:"代金券"},{type:"1",info:"课时券"},{type:"2",info:"折扣券"}],e.bgcolor=[{val:"#FDB244",info:"课时券FDB244"},{val:"#FD5B44",info:"代金券FD5B44"},{val:"#44A5FD",info:"折扣券44A5FD"}],e.genrule=[],e.userule=[],$.AJAX({type:"get",url:config.basePath+"coupon/use-list",success:function(t){e.useList=JSON.parse(t.result.pageData);for(var a=0;a<e.useList.length;a++)e.genrule.push(e.useList[a].conditionid);e.genrule=e.genrule.sort(function(e,t){return e-t}),e.userule=e.genrule,e.$apply()}}),$.AJAX({type:"get",url:config.basePath+"coupon/eve-tip",success:function(t){e.rListen=[],console.log(t);var a=JSON.parse(t.result.pageData);for(i=0;i<a.length;i++)a[i].eventtopic&&e.rListen.push(a[i].eventtopic)}}),e.genRuleI=1,e.useRuleI=1,e.zItemDel=function(e){$(e.target).parent(".item-auto-label").parent(".item-auto-item").slideUp("normal").remove()},e.zItemAdd=function(a,r){var i="";switch(r){case"gen":i="获取";break;case"use":i="使用"}e.autoFormItemTPL='<div class="item-auto-item form-group z-mb10 '+r+'ItemAuto"><label class="item-auto-label item-auto-del"><div ng-click="zItemDel($event)" class="z-ico-del">X</div></label><div class="item-auto-con"><select class="form-control '+r+'-form-control z-valid z-required z-required-select" ng-focus="formFocus($event)" ng-blur="formBlur($event)"><option value="">选择'+i+'规则</option><option ng-repeat="rule in genrule" ng-bind="rule" value="{{rule}}"></option></select></div></div>',$(a.target).parent(".item-auto-btn").before(t(e.autoFormItemTPL)(e))},$.AJAX({type:"get",url:config.basePath+"school/queryCity",data:{rlevel:2,pid:""},success:function(t){e.citys=JSON.parse(t.result.pageData),e.$apply()}}),e.selSendWay=function(t,a){e.editData.sendWay=a,0==a?$(".sel-listen-way").css("display","inline-block").addClass("z-required z-required-select"):1==a&&($(".sel-listen-way").css("display","none").removeClass("z-required z-required-select"),$(".form-group-send-way .z-error-txt").remove(),e.editData.eventtopic="")},e.changeCouponType=function(){var t=$("#offType").val();$(".off-type-wrap input.z-valid").css("border-color","#ccc").parents(".form-group").children("p.z-error-txt").remove(),o=!0;var t=$("#offType").val();0==t&&($(".off-count").siblings().css("display","none"),$(".off-count").css("display","block").find("input.form-control").removeAttr("disabled").addClass("z-required z-required-num").attr("placeholder","请输入抵扣金额"),e.editData.discount=0),2==t&&($(".off-percent").siblings().css("display","none"),$(".off-percent").css("display","block").find("input.form-control").removeAttr("disabled").addClass("z-required z-required-per").attr("placeholder","请输入折扣百分比"),e.editData.moneyvalue=0),1==t&&($(".off-percent").siblings().css("display","none"),$(".off-percent").css("display","block").find("input.form-control").attr({disabled:"true",placeholder:"课时券默认为100%",value:100}),e.editData.discount=100,e.editData.moneyvalue=0)};var o=!0;$(".z-valid-form").on("focus",".z-valid",function(){$(this).css("border-color","#ccc").parents(".form-group").children("p.z-error-txt").remove(),o=!0}),$(".z-valid-form .z-valid").blur(function(){function e(e,t){e.css("border-color","red").parents(".form-group").append('<p class="ion-close-circled z-error-txt">'+e.attr("placeholder")+","+t+"</p>")}var t=$(this);t.hasClass("z-required")&&!t.val()&&(e(t,""),o=!1),t.hasClass("z-required-2-20-special")&&!regCombination("special",[2,20]).test(t.val().trim())&&(e(t,"限2~20字符，无特殊字符"),o=!1),t.hasClass("z-required-gt-10")&&t.val().trim().length<10&&(e(t,"限10字符以上"),o=!1),t.hasClass("z-required-select")&&!t.val()&&(e(t,""),o=!1),t.hasClass("z-required-num")&&!regCombination("number").test(t.val().trim())&&(e(t,"限数字"),o=!1),t.hasClass("z-required-natural-lt120000")&&(!regCombination("number").test(t.val().trim())||t.val()<=0||t.val()>12e4)&&(e(t,"限0-120000以内"),o=!1),t.hasClass("z-required-per")&&(t.val()<0||t.val()>100)&&(e(t,"限0-100数字"),o=!1)}),e.submitEditMsg=function(){if($(".z-valid-form .z-required").each(function(){$(this).val()||($(this).css("border-color","red").parents(".form-group").append('<p class="ion-close-circled z-error-txt">'+$(this).attr("placeholder")+"</p>"),o=!1)}),!o)return!1;e.genRuleArr=[];var t="(%s ";$(".gen-form-control").each(function(){e.genRuleArr.push($(this).val()),t+="and %s "}),t=t.substring(0,t.length-8)+")|",e.editData.genrule=t+e.genRuleArr.join(","),e.useRuleArr=[];var a="(%s ";$(".use-form-control").each(function(){e.useRuleArr.push($(this).val()),a+="and %s "}),a=a.substring(0,a.length-8)+")|",e.editData.userule=a+e.useRuleArr.join(",");var r={name:e.editData.name,type:e.editData.type,limitvalue:100*e.editData.limitvalue,indepentuse:e.editData.indepentuse,genrule:e.editData.genrule,userule:e.editData.userule,listbackimg:e.editData.listbackimg,moneyvalue:e.editData.moneyvalue?100*e.editData.moneyvalue:"-",validityperiod:e.editData.validityperiod,qrcodeurl:e.editData.qrcodeurl,discount:e.editData.discount?e.editData.discount:0,eventtopic:e.editData.eventtopic,total:e.editData.total,jpushmsg:e.editData.jpushmsg,usenote:e.editData.usenote,isexist:0,haveused:0};Layer.confirm({width:300,height:160,title:"您确认发布吗？",header:"发布优惠券"},function(){$.AJAX({url:config.basePath+"coupon/add-coupon",data:r,success:function(e){Layer.alert({width:300,height:160,title:"发布成功",header:"发布优惠券"}),window.location.href="coupon.html"}})})}}]);