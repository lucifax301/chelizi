var app=angular.module("app",["ngFilter"]);app.controller("EditRechargePrivePlan",["$scope","$compile","$filter",function(e,t,a,i){e.defaultPage=location.hash.substring(2)||1,e.rcid=getQueryString("rcid"),e.editData={},$.AJAX({type:"get",url:config.basePath+"school/queryCity",data:{rlevel:2,pid:""},success:function(t){e.citys=JSON.parse(t.result.pageData),e.$apply()}}),$("#reservStart").daterangepicker({format:"YYYY-MM-DD",singleDatePicker:!0,autoclose:!0,timePicker:!0,timePicker24Hour:!0,timePickerSeconds:!0,autoApply:!0,locale:{format:"YYYY-MM-DD HH:mm:ss"}}),$("#reservEnd").daterangepicker({format:"YYYY-MM-DD",singleDatePicker:!0,autoclose:!0,timePicker:!0,timePicker24Hour:!0,timePickerSeconds:!0,autoApply:!0,locale:{format:"YYYY-MM-DD HH:mm:ss"}}),e.setPriviType=function(e){$(".z-privi-type").css("display","none").find(".z-error-txt").remove(),$(".z-privi-type").find(".z-valid").removeClass("z-required z-required-moneystep").val("").css("borderColor","#ccc"),$(".z-privi-type"+e).css("display","block").find(".z-valid").addClass("z-required z-required-moneystep"),$(".per-per").removeClass("z-required-moneystep")},e.setEnroll=function(t,a){e.editData.enroll=a,1==a&&$(".cityWrap").css("display","block"),0==a&&$(".cityWrap").css("display","none")},e.checkCitySel=function(e){$(e.target).attr("checked")?$(e.target).removeAttr("checked"):$(e.target).attr("checked","checked")},e.setVType=function(t){e.editData.vtype=t},e.setAuto=function(t,a){e.editData.auto=a},e.setTimeType=function(e){0==e&&$(".privi-time-wrap").css("display","block").find("input.ng-valid").addClass("z-required"),1==e&&$(".privi-time-wrap").css("display","none").find("input.ng-valid").removeClass("z-required")},e.getDataList=function(){$.AJAX({type:"get",url:config.basePath+"vip/recharge-plan",data:{rcid:e.rcid},success:function(t){if(e.editData=JSON.parse(t.result.pageData),console.log(e.editData),$(".vtype"+e.editData.vtype).attr("checked","checked"),1==e.editData.vtype&&$(".vtype2").attr("disabled","disabled"),2==e.editData.vtype&&$(".vtype1").attr("disabled","disabled"),1==e.editData.enroll){$(".cityWrap").css("display","block");var a=e.editData.cityId.length>0?e.editData.cityId.split(","):"";$(".city-box").each(function(){$.inArray($(this).val(),a)>=0&&$(this).attr("checked","checked")})}e.rcPerRepeat=[],e.editData.rechargeGearList[0].percent&&($(".sendWay-per").attr("checked","checked"),$(".z-privi-type0").show(),e.rcPerRepeat=e.editData.rechargeGearList),e.rcCntRepeat=[],e.editData.rechargeGearList[0].money&&($(".sendWay-cnt").attr("checked","checked"),$(".z-privi-type1").show(),e.rcCntRepeat=e.editData.rechargeGearList),e.editData.tstart&&e.editData.tend?($(".timeTypeRadio0").attr("checked","checked"),$(".privi-time-wrap").show(),e.editData.tstart=new Date(e.editData.tstart).date("y-m-d h:i:s"),e.editData.tend=new Date(e.editData.tend).date("y-m-d h:i:s")):$(".timeTypeRadio1").attr("checked","checked"),e.$apply()}})},e.getDataList(),e.zItemAdd=function(a,i,r,l){var s="";"per"==l&&(s="z-required-per"),"cnt"==l&&(s="z-required-moneystep"),e.autoFormItemTPL='<tr class="item-auto-item form-group z-mb10"><td width="15%" align="right"><label class="item-auto-label item-auto-del"><div ng-click="zItemDel($event)" class="z-ico-del">X</div></label></td><td width="42.5%"><div class="z-form-group z-auto-hide"><input type="text" class="form-control z-valid z-required z-required-moneystep z-fl step-min '+l+'-min" placeholder="请输入金额档位"><input type="text" class="form-control z-valid z-required z-required-moneystep z-fl step-max '+l+'-max" placeholder="请输入金额档位"></div></td><td width="42.5%"><div class="check-box-item"><label>设置赠送'+i+'：</label></div><div class="z-inline-block z-form-control z-form-group"><input type="text" class="form-control z-valid z-required '+s+" "+l+"-"+l+'" placeholder="请设置赠送'+i+'"></div><span class="unit">'+r+"</span></td></tr>",$(a.target).parent("td").parent("tr").before(t(e.autoFormItemTPL)(e))},e.zItemDel=function(e){$(e.target).parent("label").parent("td").parent("tr").slideUp().remove()};var r=!0;$(".z-valid-form").on("focus",".z-valid",function(){$(this).css("border-color","#ccc").parents(".z-form-group").children("p.z-error-txt").remove(),r=!0}),$(".z-valid-form").on("blur",".z-valid",function(){function e(e,t){e.css("border-color","red").parents(".z-form-group").append('<p class="ion-close-circled z-error-txt">'+e.attr("placeholder")+","+t+"</p>")}var t=$(this);t.hasClass("z-required")&&!t.val()&&(e(t,""),r=!1),t.hasClass("z-required-2-20-special")&&!regCombination("special",[2,20]).test(t.val().trim())&&(e(t,"限2~20字符，无特殊字符"),r=!1),t.hasClass("z-required-gt-10")&&t.val().trim().length<10&&(e(t,"限10字符以上"),r=!1),t.hasClass("z-required-select")&&!t.val()&&(e(t,""),r=!1),t.hasClass("z-required-num")&&!regCombination("number").test(t.val().trim())&&(e(t,"限数字"),r=!1),t.hasClass("z-required-lt-11")&&(!regCombination("number").test(t.val().trim())||t.val().trim().length>11)&&(e(t,"限数字,不超过11位"),r=!1),t.hasClass("z-required-lt2147483648")&&(!regCombination("number").test(t.val().trim())||t.val()<=0||t.val()>2147483647)&&(e(t,"数值大小超出限制"),r=!1),t.hasClass("z-required-moneystep")&&(!/^\d+(\.\d{1,2})?$/.test(t.val().trim())||t.val().trim()>1e4||t.val().trim()<.01)&&(e(t,"0.01≤X≤10000"),r=!1),t.hasClass("z-required-natural-lt10000")&&(!regCombination("number").test(t.val().trim())||t.val()<=0||t.val()>1e4)&&(e(t,"大于零小于一万"),r=!1),t.hasClass("z-required-per")&&(isNaN(t.val().trim())||t.val()<0||t.val()>100)&&(e(t,"0≤X≤100"),r=!1)}),e.submitEditMsg=function(){if($(".z-valid-form .z-required").each(function(){$(this).val()||($(this).css("border-color","red").parents(".z-form-group").append('<p class="ion-close-circled z-error-txt">'+$(this).attr("placeholder")+"</p>"),r=!1)}),!r)return Layer.alert({width:300,height:150,type:"msg",title:"您有未填的表单项"}),!1;var t=[],a=[],i=[],l=[],s=[],c=[];$(".per-min").each(function(){$(this).val()&&t.push(100*$(this).val())}),$(".per-max").each(function(){$(this).val()&&a.push(100*$(this).val())}),$(".per-per").each(function(){$(this).val()&&i.push($(this).val())}),$(".cnt-min").each(function(){$(this).val()&&l.push(100*$(this).val())}),$(".cnt-max").each(function(){$(this).val()&&s.push(100*$(this).val())}),$(".cnt-cnt").each(function(){$(this).val()&&c.push(100*$(this).val())});var n="",d="",o=null,p=null;0==t.length&&0==a.length&&(n=l.join(","),d=s.join(","),o=c.join(",")),0==l.length&&0==s.length&&(n=t.join(","),d=a.join(","),p=i.join(",")),1==e.editData.enroll&&(console.log("enroll:"+e.editData.enroll),e.cityIdTmp=[],e.cityNameTmp=[],$('.cityWrap input[name="cityBox"]:checked').each(function(){""!=$(this).val()&&(e.cityIdTmp.push($(this).val()),e.cityNameTmp.push($(this).attr("confirmTxt")))}),e.editData.cityId=e.cityIdTmp.length>0?e.cityIdTmp.join(","):" ",e.editData.cityName=e.cityNameTmp.length>0?e.cityNameTmp.join(","):" ");var m={rcid:e.editData.rcid,rcname:e.editData.rcname,pmin:n,pmax:d,percent:p,money:o,enroll:e.editData.enroll,tstart:e.editData.tstart,tend:e.editData.tend,auto:e.editData.auto,jpush:e.editData.jpush,reems:97747,agreement:e.editData.agreement,active:0,vtype:e.editData.vtype,cityId:e.editData.cityId,cityName:e.editData.cityName};return console.log(m),r?void Layer.confirm({width:300,height:160,title:"您确认修改吗？",header:"编辑优惠券"},function(){$.AJAX({url:config.basePath+"vip/edit-plan",data:m,success:function(e){Layer.alert({width:300,height:160,title:"修改成功",header:"编辑优惠券"}),window.location.href="app-client-plan.html"}})}):!1}}]);