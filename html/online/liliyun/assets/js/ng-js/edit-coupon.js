var app=angular.module("app",["ngFilter"]);app.controller("CouponEdit",["$scope","$compile","$filter",function(e,t,a,i){function r(){$(".off-count").siblings().css("display","none"),$(".off-count").css("display","block").find("input.form-control").removeAttr("disabled").addClass("z-required z-required-num").attr("placeholder","请输入抵扣金额"),e.editData.discount=0}function o(){$(".off-percent").siblings().css("display","none"),$(".off-percent").css("display","block").find("input.form-control").attr({disabled:"true",placeholder:"课时券默认为100%",value:100}),e.editData.discount=100,e.editData.moneyvalue=0}function n(){$(".off-percent").siblings().css("display","none"),$(".off-percent").css("display","block").find("input.form-control").removeAttr("disabled").addClass("z-required z-required-per").attr("placeholder","请输入折扣百分比"),e.editData.moneyvalue="0"}e.defaultPage=location.hash.substring(2)||1,e.coupontmpid=getQueryString("coupontmpid"),e.stockid=getQueryString("stockId"),e.editData={},e.genrule=[],e.userule=[],$.AJAX({type:"get",url:config.basePath+"coupon/use-list",success:function(t){e.useList=JSON.parse(t.result.pageData);for(var a=0;a<e.useList.length;a++)e.genrule.push(e.useList[a].conditionid);e.genrule=e.genrule.sort(function(e,t){return e-t}),e.userule=e.genrule,e.$apply()}}),e.couponType=[{type:"0",info:"代金券"},{type:"1",info:"课时券"},{type:"2",info:"折扣券"}],e.bgcolor=[{val:"#FDB244",info:"课时券FDB244"},{val:"#FD5B44",info:"代金券FD5B44"},{val:"#44A5FD",info:"折扣券44A5FD"}],e.getDataList=function(){$.AJAX({type:"get",url:config.basePath+"coupon/coupon-view",data:{coupontmpid:e.coupontmpid},success:function(t){e.editData=JSON.parse(t.result.coupon),e.editData.moneyvalue=e.editData.moneyvalue/100,e.editData.limitvalue=e.editData.limitvalue/100,e.genRuleArray=e.editData.genrule.split("|")[1]?e.editData.genrule.split("|")[1].split(","):[],e.useRuleArray=e.editData.userule.split("|")[1]?e.editData.userule.split("|")[1].split(","):[],e.$apply()}})},e.getDataList(),$.AJAX({type:"get",url:config.basePath+"coupon/eve-tip",success:function(t){e.rListen=[];for(var a=JSON.parse(t.result.pageData),i=0;i<a.length;i++)a[i].eventtopic&&e.rListen.push(a[i].eventtopic)}}),e.genRuleI=1,e.useRuleI=1,e.zItemDel=function(e){$(e.target).parent(".item-auto-label").parent(".item-auto-item").slideUp("normal").remove()},e.zItemAdd=function(a,i){$(a.target).parent(".item-auto-btn").prev("p.unavaible-rule").remove();var r="";switch(i){case"gen":r="获取";break;case"use":r="使用"}e.autoFormItemTPL='<div class="item-auto-item form-group z-mb10 '+i+'ItemAuto"><label class="item-auto-label item-auto-del"><div ng-click="zItemDel($event)" class="z-ico-del">X</div></label><div class="item-auto-con"><select class="form-control '+i+'-form-control z-valid z-required z-required-select"><option value="">选择'+r+'规则</option><option ng-repeat="rule in genrule" ng-bind="rule" value="{{rule}}"></option></select></div></div>',$(a.target).parent(".item-auto-btn").before(t(e.autoFormItemTPL)(e))},$.AJAX({type:"get",url:config.basePath+"school/queryCity",data:{rlevel:2,pid:""},success:function(t){e.citys=JSON.parse(t.result.pageData),e.$apply()}}),e.selSendWay=function(t,a){e.editData.sendWay=a,0==a?$(".sel-listen-way").css("display","inline-block").addClass("z-required z-required-select"):1==a&&($(".sel-listen-way").css("display","none").removeClass("z-required z-required-select"),$(".form-group-send-way .z-error-txt").remove(),e.editData.eventtopic="")},clearTimeout("loadEditDataType"),loadEditDataType=setTimeout(function(){0==e.editData.type&&r(),1==e.editData.type&&o(),2==e.editData.type&&n(),e.editData.eventtopic&&($(".send-way .inputbox input:eq(0)").attr("checked","checked"),$(".send-way .sel-listen-way").css("display","inline-block"),$(".send-way .sel-listen-way").val(e.editData.eventtopic)),e.editData.eventtopic||($(".send-way .inputbox input:eq(1)").attr("checked","checked"),$(".send-way .sel-listen-way").css("display","none"))},1e3),e.changeCouponType=function(){var e=$("#offType").val();$(".off-type-wrap input.z-valid").css("border-color","#ccc").parents(".form-group").children("p.z-error-txt").remove(),s=!0,0==e&&r(),1==e&&o(),2==e&&n()};var s=!0;$(".z-valid-form").on("focus",".z-valid",function(){$(this).css("border-color","#ccc").parents(".form-group").children("p.z-error-txt").remove(),s=!0}),$(".z-valid-form .z-valid").blur(function(){function e(e,t){e.css("border-color","red").parents(".form-group").append('<p class="ion-close-circled z-error-txt">'+e.attr("placeholder")+","+t+"</p>")}var t=$(this);t.hasClass("z-required")&&!t.val()&&(e(t,""),s=!1),t.hasClass("z-required-2-20-special")&&!regCombination("special",[2,20]).test(t.val().trim())&&(e(t,"限2~20字符，无特殊字符"),s=!1),t.hasClass("z-required-gt-10")&&t.val().trim().length<10&&(e(t,"限10字符以上"),s=!1),t.hasClass("z-required-select")&&!t.val()&&(e(t,""),s=!1),t.hasClass("z-required-num")&&!regCombination("number").test(t.val().trim())&&(e(t,"限数字"),s=!1),t.hasClass("z-required-natural-lt120000")&&(!regCombination("number").test(t.val().trim())||t.val()<=0||t.val()>12e4)&&(e(t,"限0-120000以内"),s=!1),t.hasClass("z-required-per")&&(t.val()<0||t.val()>100)&&(e(t,"限0-100数字"),s=!1)}),e.submitEditMsg=function(){if($(".z-valid-form .z-required").each(function(){$(this).val()||($(this).css("border-color","red").parents(".form-group").append('<p class="ion-close-circled z-error-txt">'+$(this).attr("placeholder")+"</p>"),s=!1)}),!s)return!1;e.genRuleArr=[];var t="(%s ";$(".gen-form-control").each(function(){e.genRuleArr.push($(this).val()),t+="and %s "}),t=t.substring(0,t.length-8)+")|",e.editData.genrule=t+e.genRuleArr.join(","),e.useRuleArr=[];var i="(%s ";$(".use-form-control").each(function(){e.useRuleArr.push($(this).val()),i+="and %s "}),i=i.substring(0,i.length-8)+")|",e.editData.userule=i+e.useRuleArr.join(",");var r={coupontmpid:e.coupontmpid,stockid:e.stockid,name:e.editData.name,type:e.editData.type,limitvalue:100*e.editData.limitvalue,indepentuse:e.editData.indepentuse,genrule:e.editData.genrule,userule:e.editData.userule,listbackimg:e.editData.listbackimg,moneyvalue:e.editData.moneyvalue?100*e.editData.moneyvalue:0,validityperiod:e.editData.validityperiod,qrcodeurl:e.editData.qrcodeurl,createtime:a("date")(new Date(e.editData.createtime),"yyyy-MM-dd HH:mm:ss"),eventtopic:e.editData.eventtopic,discount:e.editData.discount?e.editData.discount:0,total:e.editData.total,jpushmsg:e.editData.jpushmsg,haveused:e.editData.haveUsed,usenote:e.editData.usenote,verify:0,isexist:0};Layer.confirm({width:300,height:160,title:"您确认修改吗？",header:"编辑优惠券"},function(){$.AJAX({url:config.basePath+"coupon/update-coupon",data:r,success:function(e){Layer.alert({width:300,height:160,title:"修改成功",header:"编辑优惠券"}),window.location.href="coupon.html"}})})}}]);