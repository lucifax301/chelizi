var app=angular.module("app",["ngFilter","ngSelects"]);app.controller("OrderDetails",["$scope","$rootScope","$filter","Selects",function(t,e,a,n){function i(e){switch(e){case 0:t.getDataList();break;case 1:t.indAccount();break;case 2:t.getStudentLogs()}}function s(e){return{url:config.basePath+e,data:{studentId:t.editData.studentId,phoneNum:t.editData.phoneNum,sex:parseInt(t.editData.sex),applyCarType:parseInt(t.editData.applyCarType),idNumber:t.editData.idNumber,name:t.editData.name}}}function d(e){var a={url:config.basePath+"order/batch",data:{pageNo:e,pageSize:parseInt(t.pageSize),studentId:t.studentId,orderId:t.orderId,payState:t.payState}};return a}function o(e){var n={url:config.basePath+"student/account",data:{pageNo:e,pageSize:t.pageSize,studentId:t.studentId,startTime:t.startTime?t.startTime:a("date")((new Date).getTime()-6048e5,"yyyy-MM-dd"),endTime:t.endTime?t.endTime:a("date")((new Date).getTime(),"yyyy-MM-dd"),operateType:t.operateType,channel:t.channel,isEarning:t.isEarning,isBalance:t.isBalance}};return n}function r(e){var a={url:config.basePath+"logCommon/batch",data:{pageNo:e,pageSize:t.logPageSize,menuId:1,relateId:t.studentId}};return a}t.studentId=getQueryString("studentId"),t.defaultPage=location.hash.substring(2)||1,t.pageSize=10,t.index=0,$(function(){getQueryString("tab")&&t.tableSwitch(parseInt(getQueryString("tab")))}),t.tableSwitch=function(e){t.index=tabPageDetails(e),win.showLoading(),location.hash="##1",i(t.index)},window.onhashchange=function(){win.showLoading(),t.defaultPage=location.hash.substring(2)||1,i(t.index)},t.getStudentData=function(){$.AJAX({type:"get",url:config.basePath+"student/view",data:{studentId:t.studentId},success:function(e){t.studentDetails=JSON.parse(e.result.student),t.getDataList(),t.$apply()}})},t.getStudentData(),t.sutdentEditLoad=function(){$(".closeAlert").click(function(){$(this).parents("div.edit-alert").fadeOut("fast")})},t.editData={},t.studentEdit=function(e){$(".student-alert").fadeIn("fast"),$("#student-alert").css("marginTop",parseInt(($(win).height()-$("#student-alert").height()-100)/2)+"px"),t.editData=e},t.submitEditMsg=function(e){var a=s("student/update");return t.editData.name&&regCombination("*").test(t.editData.name)?void $.AJAX({url:a.url,data:a.data,success:function(a){$(e.target).parents("div.edit-alert").fadeOut("fast"),Layer.miss({width:250,height:90,title:"操作成功",closeMask:!0}),t.getStudentData()}}):(Layer.alert({width:300,height:150,type:"msg",title:"请填写学员姓名"}),!1)},t.closeAlert=function(){t.getStudentData()},t.pageSize=10,t.orderId="",t.payState="",t.getDataList=function(){var e=d(t.defaultPage);$.AJAX({type:"get",url:e.url,data:e.data,success:function(e){var a=getListData(e);t.datas=a.dataList,n.selects({datas:t.datas,whichId:"orderId"}),t.$apply(),topLongText(),new Page({parent:$("#copot-page"),nowPage:t.defaultPage,pageSize:t.pageSize,totalCount:a.total})}})},t.getDataForPage=function(){win.showLoading(),t.getDataList()},t.getDataForSearch=function(){win.showLoading(),t.getDataList()},t.getDataForPayment=function(e,a){$(e.target).addClass("active").siblings().removeClass("active"),win.showLoading(),t.payState=a,t.getDataList()},t.closeOrder=function(){if(!e.idList.length)return Layer.alert({width:300,height:150,type:"msg",title:"请选择需要关闭的订单！"}),!1;var a=getDataForKey({datas:t.datas,id:"orderId",idList:e.idList});Layer.confirm({width:300,height:160,title:"确认关闭选中的订单吗？",header:"关闭订单"},function(){$.AJAX({url:config.basePath+"order/update-batch",data:{orderIds:e.idList.toString(),studentIds:getKeyArrFromData(a,"studentId").toString(),coachIds:getKeyArrFromData(a,"coachId").toString()},success:function(a){e.idList=[],Layer.miss({width:250,height:90,title:"操作成功",closeMask:!0}),t.getDataList()}})})},t.channel="1",t.isEarning="0",t.isBalance="",t.indAccount=function(){var e=o(t.defaultPage);$.AJAX({type:"get",url:e.url,data:e.data,success:function(e){t.stuAccount=JSON.parse(e.result.stuInfo),t.stuBankList=JSON.parse(e.result.bankList),t.stuMoneyList=JSON.parse(e.result.moneyList),t.stuCouponList=JSON.parse(e.result.couponList),t.stuSumMoney=JSON.parse(e.result.sumMoney),console.log(t.stuMoneyList),t.$apply(),new Page({parent:$(".total-page"),nowPage:t.defaultPage,pageSize:t.pageSize,totalCount:t.stuMoneyList.total})}})},t.fy=function(){location.hash="##1",t.channel="1",t.isEarning=0,t.isBalance="",t.indAccount()},t.ye=function(){location.hash="##1",t.channel="2",t.isEarning="",t.isBalance=1,t.indAccount()},t.getDataForTime=function(e,n){switch($(e.target).addClass("active").siblings().removeClass("active"),location.hash="##1",n){case"1":t.startTime=a("date")((new Date).getTime()-6048e5,"yyyy-MM-dd"),t.endTime=a("date")((new Date).getTime(),"yyyy-MM-dd");break;case"2":t.startTime=a("date")((new Date).getTime()-2592e6,"yyyy-MM-dd"),t.endTime=a("date")((new Date).getTime(),"yyyy-MM-dd");break;case"3":t.startTime=a("date")((new Date).getTime()-31536e6,"yyyy-MM-dd"),t.endTime=a("date")((new Date).getTime(),"yyyy-MM-dd")}win.showLoading(),t.indAccount()},$("#reservation").daterangepicker({format:"YYYY/MM/DD"},function(e,n,i){t.startTime=t.endTime="",t.startTime=a("date")(e.toISOString(),"yyyy-MM-dd"),t.endTime=a("date")(n.toISOString(),"yyyy-MM-dd"),win.showLoading(),t.indAccount(),t.$apply()}),t.getDataForOperate=function(){win.showLoading(),t.defaultPage=1,t.operateType=t.operateType,t.indAccount()},t.logPageSize=10,t.getStudentLogs=function(){var e=r(t.defaultPage);$.AJAX({type:"get",url:e.url,data:e.data,success:function(e){var a=getListData(e);t.studentLogs=a.dataList,t.$apply(),new Page({parent:$("#log-page"),nowPage:t.defaultPage,pageSize:t.pageSize,totalCount:a.total})}})}}]);