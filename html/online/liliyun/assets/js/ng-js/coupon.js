var app=angular.module("app",["ngFilter","ngSelects"]);app.controller("Coupon",["$scope","$rootScope","$filter","Selects",function(t,e,a,i){function s(e){var a={url:config.basePath+"coupon/coupon-batch",data:{pageNo:e,pageSize:parseInt(t.pageSize),startTime:t.startTime,endTime:t.endTime,applyCarType:t.carType,type:t.type,verify:t.verify}};return a}t.defaultPage=location.hash.substring(2)||1,t.pageSize=10,t.startTime="",t.endTime="",t.type="",t.verify="",i.selects({datas:t.datas,whichId:"coupontmpid"}),t.getDataList=function(){var e=s(t.defaultPage);$.AJAX({type:"get",url:e.url,data:e.data,success:function(e){var a=getListData(e);t.total=a.total,t.datas=a.dataList,i.selects({datas:t.datas,whichId:"coupontmpid"}),t.$apply(),topLongText(),new Page({parent:$("#copot-page"),nowPage:t.defaultPage,pageSize:t.pageSize,totalCount:a.total})}})},t.getDataList(),window.onhashchange=function(){win.showLoading(),t.defaultPage=location.hash.substring(2)||1,t.getDataList()},t.getDataForTime=function(e,i){switch($(e.target).addClass("active").siblings().removeClass("active"),i){case"all":t.startTime=t.endTime="";break;case"0":t.startTime=a("date")((new Date).getTime()-6048e5,"yyyy-MM-dd"),t.endTime=a("date")((new Date).getTime(),"yyyy-MM-dd");break;case"1":t.startTime=a("date")((new Date).getTime()-1296e6,"yyyy-MM-dd"),t.endTime=a("date")((new Date).getTime(),"yyyy-MM-dd")}t.defaultPage=1,win.showLoading(),t.getDataList()},$("#reservation").daterangepicker({format:"YYYY/MM/DD"},function(e,i,s){t.startTime=t.endTime="",t.startTime=a("date")(e.toISOString(),"yyyy-MM-dd"),t.endTime=a("date")(i.toISOString(),"yyyy-MM-dd"),t.defaultPage=1,win.showLoading(),t.getDataList(),t.$apply()}),t.getTypeState=function(e,a){$(e.target).addClass("active").siblings().removeClass("active"),win.showLoading(),t.defaultPage=1,t.type=a,t.getDataList()},t.getVerifyState=function(e,a){$(e.target).addClass("active").siblings().removeClass("active"),win.showLoading(),t.defaultPage=1,t.verify=a,t.getDataList()},t.getDataForPage=function(){win.showLoading(),t.defaultPage=1,t.getDataList()},t.activeAction=function(a){var i={msgWords:"",msgUrl:"",msgCode:""};switch(a){case"cActive":i.msgWords="激活",i.msgUrl=config.basePath+"coupon/active-coupon",i.msgCode=0,i.msgWords2="未激活";break;case"cCancle":i.msgWords="停用",i.msgUrl=config.basePath+"coupon/cancle-coupon",i.msgCode=1,i.msgWords2="已激活"}if(!e.idList.length)return Layer.alert({width:300,height:150,type:"msg",title:"请选择需要"+i.msgWords+"的券模板！"}),!1;for(var s=getDataForKey({datas:t.datas,id:"coupontmpid",idList:e.idList}),o=!0,d="",n=0;n<s.length;n++){if(s[n].isexist!=i.msgCode){d="您只能选择"+i.msgWords2+"的优惠券，<br>请重新选择！",o=!1;break}if(1!=s[n].verify){d="您只能选择审核通过的优惠券，<br>请重新选择！",o=!1;break}}return o?void Layer.confirm({width:300,height:160,title:"确认"+i.msgWords+"选中券模板吗？",header:i.msgWords+"关闭券模板"},function(){$.AJAX({url:i.msgUrl,data:{ids:e.idList.toString()},success:function(a){e.idList=[],Layer.miss({width:250,height:90,title:"操作成功",closeMask:!0}),t.getDataList()}})}):(Layer.alert({width:330,height:175,type:"msg",title:d}),!1)},t.verifyAction=function(a){t.alertText="";var i={msgWords:"",msgUrl:"",msgCode:[]};switch(a){case"vPass":i.msgWords="通过",i.msgUrl=config.basePath+"coupon/audit-coupon",i.msgCode=[0,2],i.msgWords2="未审核或未通过";break;case"vFail":i.msgWords="不通过",i.msgUrl=config.basePath+"coupon/unaudit-coupon",i.msgCode=[0],i.msgWords2="未审核"}if(!e.idList.length)return Layer.alert({width:325,height:160,type:"msg",title:"请选择需要"+i.msgWords+"的券模板！"}),!1;for(var s=getDataForKey({datas:t.datas,id:"coupontmpid",idList:e.idList}),o=!0,d=0;d<s.length;d++)if(i.msgCode.indexOf(s[d].verify)<0){o=!1;break}return o?void Layer.confirm({width:300,height:160,title:"确认"+i.msgWords+"选中券模板吗？",header:i.msgWords+"券模板"},function(){$.AJAX({url:i.msgUrl,data:{couponTempIds:e.idList.toString()},success:function(a){e.idList=[],Layer.miss({width:250,height:90,title:"操作成功",closeMask:!0}),t.getDataList()}})}):(Layer.alert({width:430,height:175,type:"msg",title:"您只能选择状态为"+i.msgWords2+"的优惠券，<br>请重新选择！"}),!1)},t.addCouponLoad=function(){$(".closeAlert").click(function(){$(this).parents("div.add-coach").fadeOut("fast")})},t.addCoupon=function(e){$(".add-coach").fadeIn("fast"),$("#add-coach").css("marginTop",parseInt(($(win).height()-$("#add-new-car").height()-200)/2)+"px"),t.addCoachNub="",t.coupontmpId=e.coupontmpid,t.name=e.name,t.releasedAmount=e.releasedAmount,t.leftAmount=e.leftAmount},t.submitCoachMsg=function(e){return regCombination("*").test(t.addCoachNub)?/^[0-9]*[1-9][0-9]*$/.test(t.addCoachNub)?void $.AJAX({url:config.basePath+"coupon/add-stock",data:{couponTmpId:t.coupontmpId,addTotal:t.addCoachNub},success:function(a){$(e.target).parents("div.add-coach").fadeOut("fast"),Layer.miss({width:250,height:90,title:"操作成功",closeMask:!0}),t.getDataList()}}):(Layer.alert({type:"msg",title:"追加发行量不合法!"}),!1):(Layer.alert({type:"msg",title:"请输入追加发行的数量!"}),!1)}}]);