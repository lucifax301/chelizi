var app=angular.module("app",["ngFilter","ngSelects"]);app.controller("Order",["$scope","$rootScope","$filter","Selects",function(t,e,a,i){function d(e){var a={url:config.basePath+"order/batch",data:{pageNo:e,pageSize:parseInt(t.pageSize),startTime:t.startTime,endTime:t.endTime,subject:t.subject,payState:t.payState,orderState:t.orderState,applyCarType:t.carType,otype:t.otype,dltype:t.dltype,sustainTime:t.sustainTime}};return a.data[t.searchType]=t.search,a}t.defaultPage=location.hash.substring(2)||1,t.pageSize=10,t.startTime="",t.endTime="",t.subject="",t.orderId="",t.orderState="",t.payState="",t.forPayment="",t.searchType="orderId",t.otype="",t.search="",t.carType="",t.dltype="",t.sustainTime="",t.data={pages:10,total:100,pageSize:10,pageNo:1,dataList:[{orderId:"0121545wfewefwefwvrt0rg",studentId:25,studentName:"小张",coachId:1151,coachName:"张教练",payment:0},{orderId:"15616516egergerferferfer",studentId:26,studentName:"小张",coachId:1152,coachName:"张教练",payment:1},{orderId:"216sefewsfs516516eferfer",studentId:27,studentName:"小张",coachId:1153,coachName:"张教练",payment:0}]},t.datas=t.data.dataList,i.selects({datas:t.datas,whichId:"orderId"}),t.getDataList=function(){var e=d(t.defaultPage);$.AJAX({type:"get",url:e.url,data:e.data,success:function(e){var a=getListData(e);t.total=a.total,t.datas=a.dataList,i.selects({datas:t.datas,whichId:"orderId"}),t.$apply(),topLongText(),new Page({parent:$("#copot-page"),nowPage:t.defaultPage,pageSize:t.pageSize,totalCount:a.total})}})},t.getDataList(),window.onhashchange=function(){win.showLoading(),t.defaultPage=location.hash.substring(2)||1,t.getDataList()},t.getDataForTime=function(e,i){switch($(e.target).addClass("active").siblings().removeClass("active"),i){case"all":t.startTime=t.endTime="";break;case"0":t.startTime=a("date")((new Date).getTime()-6048e5,"yyyy-MM-dd"),t.endTime=a("date")((new Date).getTime(),"yyyy-MM-dd");break;case"1":t.startTime=a("date")((new Date).getTime()-1296e6,"yyyy-MM-dd"),t.endTime=a("date")((new Date).getTime(),"yyyy-MM-dd")}t.defaultPage=1,win.showLoading(),t.getDataList()},$("#reservation").daterangepicker({format:"YYYY/MM/DD"},function(e,i,d){t.startTime=t.endTime="",t.startTime=a("date")(e.toISOString(),"yyyy-MM-dd"),t.endTime=a("date")(i.toISOString(),"yyyy-MM-dd"),t.defaultPage=1,win.showLoading(),t.getDataList(),t.$apply()}),t.getDataForCarType=function(e,a){$(e.target).addClass("active").siblings().removeClass("active"),win.showLoading(),t.defaultPage=1,t.dltype=a,t.getDataList()},t.getDataForSubject=function(e,a){$(e.target).addClass("active").siblings().removeClass("active"),win.showLoading(),t.defaultPage=1,t.subject=a,t.getDataList()},t.getDataForPayment=function(e,a){$(e.target).addClass("active").siblings().removeClass("active"),win.showLoading(),t.defaultPage=1,t.payState=a,t.getDataList()},t.getSearchDay=function(e,a){win.showLoading(),t.defaultPage=1,t.sustainTime=a,t.getDataList()},t.getOrderState=function(e,a){$(e.target).addClass("active").siblings().removeClass("active"),win.showLoading(),t.defaultPage=1,t.orderState=a,t.getDataList()},t.getDataForOtype=function(e,a){$(e.target).addClass("active").siblings().removeClass("active"),win.showLoading(),t.defaultPage=1,t.otype=a,t.getDataList()},t.getDataForPage=function(){win.showLoading(),t.defaultPage=1,t.getDataList()},t.getDataForSearch=function(){win.showLoading(),t.defaultPage=1,t.getDataList()},t.closeOrder=function(){if(!e.idList.length)return Layer.alert({width:300,height:150,type:"msg",title:"请选择需要关闭的订单！"}),!1;var a=getDataForKey({datas:t.datas,id:"orderId",idList:e.idList});Layer.confirm({width:300,height:160,title:"确认关闭选中的订单吗？",header:"关闭订单"},function(){$.AJAX({url:config.basePath+"order/update-batch",data:{orderIds:e.idList.toString(),studentIds:getKeyArrFromData(a,"studentId").toString(),coachIds:getKeyArrFromData(a,"coachId").toString()},success:function(a){e.idList=[],Layer.miss({width:250,height:90,title:"操作成功",closeMask:!0}),t.getDataList()}})})},t.orderDataExport=function(){dataExportForIframe({getSearchs:d(t.defaultPage).data,total:t.total,url:"order/export-excel"})},t.hangUpOrder=function(){for(var a=!0,i=getDataForKey({datas:t.datas,id:"orderId",idList:e.idList}),d=0;d<i.length;d++)if(0!=i[d].payState){a=!1;break}return e.idList.length?0==a?(Layer.alert({width:340,height:150,type:"msg",title:"该操作只对'未付款'的订单有效！",header:"挂起订单"}),!1):void Layer.confirm({width:300,height:160,title:"您确认挂起所选订单吗？",header:"挂起订单"},function(){$.AJAX({url:config.basePath+"order/hangUp",data:{orderIdList:e.idList.toString()},success:function(e){Layer.miss({width:250,height:90,title:"操作成功",closeMask:!0}),t.getDataList()}})}):(Layer.alert({width:300,height:150,type:"msg",title:"请选择'未付款'的订单！",header:"挂起订单"}),!1)}}]);